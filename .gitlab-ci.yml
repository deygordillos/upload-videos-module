# .gitlab-ci.yml - Video Upload API DevSecOps Pipeline
# v1.0 2025-12-10
# Based on: .gitlab-ci.yml - Plantilla DevSecOps PHP
# @author SimpleData Corp

stages:
  - sanity
  - deps
  - test
  - sast
  - security
  #- build
  - deploy

variables:
  COMPOSER_ALLOW_SUPERUSER: "1"
  COMPOSER_NO_INTERACTION: "1"

# -------------------------
# ðŸŸ¢ 1. Sanity del Runner
# -------------------------
sanity:
  stage: sanity
  image: alpine:3.20
  tags: ["docker"]
  rules:
    - when: always
  script:
    - echo "Runner conectado âœ”"
    - uname -a
    - cat /etc/os-release | head -n 1

# -------------------------
# ðŸ“¦ 2. Dependencias PHP
# -------------------------
install_deps:
  stage: deps
  image: composer:latest
  tags: ["docker"]
  rules:
    - when: always
  script:
    - composer install --prefer-dist --optimize-autoloader --ignore-platform-reqs
  artifacts:
    paths:
      - vendor/
    expire_in: 1h
  cache:
    key: "composer-cache-${CI_COMMIT_REF_SLUG}"
    paths:
      - vendor/

# -------------------------
# ðŸ§ª 3. Tests (PHPUnit)
# -------------------------
php_tests:
  stage: test
  image: composer:latest
  tags: ["docker"]
  rules:
    - when: always
  needs: ["install_deps"]
  script:
    - php -v
    - composer test
  coverage: '/^\s*Lines:\s*\d+.\d+\%/'
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week

# -------------------------
# ðŸ” 4. SAST - PHPStan
# -------------------------
phpstan:
  stage: sast
  image: composer:latest
  tags: ["docker"]
  rules:
    - when: always
  needs: ["install_deps"]
  script:
    - composer analyse
  artifacts:
    when: always
    paths:
      - phpstan-report.txt
    expire_in: 1 week
  allow_failure: false

# -------------------------
# ðŸŽ¯ 5. Code style - PHPCS
# -------------------------
phpcs:
  stage: sast
  image: composer:latest
  tags: ["docker"]
  rules:
    - when: always
  needs: ["install_deps"]
  script:
    - composer lint || true
  artifacts:
    when: always
    paths:
      - phpcs-report.txt
    expire_in: 1 week
  allow_failure: true

# -------------------------
# ðŸ§ª 6. Secret Scanning - Gitleaks
# -------------------------
gitleaks_scan:
  stage: security
  image:
    name: zricethezav/gitleaks:latest
    entrypoint: [""]
  tags: ["docker"]
  rules:
    - when: always
  script:
    - gitleaks detect --source . --no-color --report-format json --report-path gitleaks-report.json --exit-code 0
  artifacts:
    paths:
      - gitleaks-report.json
    expire_in: 1 week
  allow_failure: true

# -------------------------
# ðŸ” 7. Dependency scanning
# -------------------------
composer_audit:
  stage: security
  image: composer:latest
  tags: ["docker"]
  rules:
    - when: always
  needs: ["install_deps"]
  script:
    - composer audit --format=json | tee composer-audit.json || true
  artifacts:
    paths:
      - composer-audit.json
    expire_in: 1 week
  allow_failure: true

# -------------------------
# ðŸ³ 8. Build Docker Image
# -------------------------
# build_image:
#   stage: build
#   image: docker:24-cli
#   services:
#     - docker:24-dind
#   tags: ["docker"]
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "dev"'
#   needs: ["php_tests", "phpcs"]
#   before_script:
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#   script:
#     - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE:latest .
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
#     - docker push $CI_REGISTRY_IMAGE:latest
#   only:
#     - main
#     - dev

# -------------------------
# ðŸš€ 9. Deploy to Staging
# -------------------------
# deploy_staging:
#   stage: deploy
#   image: alpine:3.20
#   tags: ["docker"]
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "dev"'
#       when: manual
#   needs: ["build_image"]
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#     - ssh-keyscan $STAGING_SERVER >> ~/.ssh/known_hosts
#   script:
#     - ssh $STAGING_USER@$STAGING_SERVER "cd /var/www/video-api && docker-compose pull && docker-compose up -d --force-recreate"
#   environment:
#     name: staging
#     url: https://staging-video-api.example.com

# -------------------------
# ðŸš€ 10. Deploy to Production
# -------------------------
# deploy_production:
#   stage: deploy
#   image: alpine:3.20
#   tags: ["docker"]
#   rules:
#     - if: '$CI_COMMIT_BRANCH == "main"'
#       when: manual
#   needs: ["build_image"]
#   before_script:
#     - apk add --no-cache openssh-client
#     - eval $(ssh-agent -s)
#     - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
#     - mkdir -p ~/.ssh
#     - chmod 700 ~/.ssh
#     - ssh-keyscan $PRODUCTION_SERVER >> ~/.ssh/known_hosts
#   script:
#     - ssh $PRODUCTION_USER@$PRODUCTION_SERVER "cd /var/www/video-api && docker-compose pull && docker-compose up -d --force-recreate"
#   environment:
#     name: production
#     url: https://video-api.example.com